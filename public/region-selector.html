<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Region Selector</title>
    <style>
      body {
        margin: 0;
        padding: 0;
        background: rgba(0, 0, 0, 0.3);
        cursor: crosshair;
        user-select: none;
        overflow: hidden;
        width: 100vw;
        height: 100vh;
        font-family: Arial, sans-serif;
      }

      #selection-overlay {
        position: absolute;
        border: 2px solid #007acc;
        background: rgba(0, 122, 204, 0.1);
        display: none;
        pointer-events: none;
      }

      #instructions {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 10px 20px;
        border-radius: 5px;
        font-size: 14px;
        z-index: 1000;
      }

      #coordinates {
        position: fixed;
        bottom: 20px;
        left: 20px;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 5px 10px;
        border-radius: 3px;
        font-size: 12px;
        font-family: monospace;
        display: none;
      }

      .cancel-btn {
        position: fixed;
        top: 20px;
        right: 20px;
        background: rgba(255, 0, 0, 0.8);
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
      }

      .cancel-btn:hover {
        background: rgba(255, 0, 0, 1);
      }
    </style>
  </head>
  <body>
    <div id="instructions">Click and drag to select a region, or press ESC to cancel</div>
    <button class="cancel-btn" onclick="cancelSelection()">Cancel</button>
    <div id="selection-overlay"></div>
    <div id="coordinates"></div>

    <script>
      const { invoke } = window.__TAURI__.core;

      let isSelecting = false;
      let startX = 0;
      let startY = 0;
      let currentX = 0;
      let currentY = 0;

      const overlay = document.getElementById('selection-overlay');
      const coordinates = document.getElementById('coordinates');

      document.addEventListener('mousedown', startSelection);
      document.addEventListener('mousemove', updateSelection);
      document.addEventListener('mouseup', endSelection);
      document.addEventListener('keydown', handleKeyDown);

      // Reset selection state when window becomes visible
      document.addEventListener('visibilitychange', function () {
        if (!document.hidden) {
          // Window became visible, reset state
          isSelecting = false;
          overlay.style.display = 'none';
          coordinates.style.display = 'none';
          startX = 0;
          startY = 0;
          currentX = 0;
          currentY = 0;
        }
      });

      function startSelection(e) {
        isSelecting = true;
        startX = e.clientX;
        startY = e.clientY;
        currentX = e.clientX;
        currentY = e.clientY;

        overlay.style.left = startX + 'px';
        overlay.style.top = startY + 'px';
        overlay.style.width = '0px';
        overlay.style.height = '0px';
        overlay.style.display = 'block';
        coordinates.style.display = 'block';

        updateCoordinatesDisplay();
      }

      function updateSelection(e) {
        if (!isSelecting) return;

        currentX = e.clientX;
        currentY = e.clientY;

        const left = Math.min(startX, currentX);
        const top = Math.min(startY, currentY);
        const width = Math.abs(currentX - startX);
        const height = Math.abs(currentY - startY);

        overlay.style.left = left + 'px';
        overlay.style.top = top + 'px';
        overlay.style.width = width + 'px';
        overlay.style.height = height + 'px';

        updateCoordinatesDisplay();
      }

      function updateCoordinatesDisplay() {
        const left = Math.min(startX, currentX);
        const top = Math.min(startY, currentY);
        const width = Math.abs(currentX - startX);
        const height = Math.abs(currentY - startY);

        coordinates.textContent = `X: ${left}, Y: ${top}, Width: ${width}, Height: ${height}`;
      }

      async function endSelection(e) {
        if (!isSelecting) return;

        isSelecting = false;

        const left = Math.min(startX, currentX);
        const top = Math.min(startY, currentY);
        const width = Math.abs(currentX - startX);
        const height = Math.abs(currentY - startY);

        // Only proceed if the selection has meaningful dimensions
        if (width > 10 && height > 10) {
          const regionData = {
            x: left,
            y: top,
            width: width,
            height: height,
          };

          try {
            await invoke('region_selected', { coordinates: regionData });
          } catch (error) {
            console.error('Error sending region coordinates:', error);
            await cancelSelection();
          }
        } else {
          // Selection too small, cancel
          await cancelSelection();
        }
      }

      async function cancelSelection() {
        // Reset the selection state
        isSelecting = false;
        overlay.style.display = 'none';
        coordinates.style.display = 'none';

        try {
          await invoke('close_region_selector');
        } catch (error) {
          console.error('Error closing region selector:', error);
        }
      }

      function handleKeyDown(e) {
        if (e.key === 'Escape') {
          cancelSelection();
        }
      }

      // Prevent context menu
      document.addEventListener('contextmenu', (e) => e.preventDefault());
    </script>
  </body>
</html>
